name: Test
on: [push, pull_request]

jobs:
  test-e1-isolation:
    name: Tests E1 Isolation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Set PYTHONPATH
        run: echo "PYTHONPATH=${{ github.workspace }}/src:$PYTHONPATH" >> $GITHUB_ENV
      
      - name: Run E1 isolation tests (fast)
        run: pytest tests/test_e1_isolation.py -v -m "not slow"
      
      - name: Validate E1 pipeline structure
        run: |
          python -c "import sys; sys.path.insert(0, 'src'); from e1.pipeline import E1Pipeline; print('✅ E1Pipeline importable')"
          python -c "import sys; sys.path.insert(0, 'src'); from shared.interfaces import E1DataReader; print('✅ E1DataReader importable')"
      
      - name: Check E1 exports structure
        run: |
          mkdir -p exports data/raw data/silver data/gold
          test -d exports && echo "✅ exports/ existe"
          test -d data && echo "✅ data/ existe"
  
  test-e1-complete:
    name: Tests E1 Complet (Slow)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Set PYTHONPATH
        run: echo "PYTHONPATH=${{ github.workspace }}/src:$PYTHONPATH" >> $GITHUB_ENV
      
      - name: Run E1 complete pipeline test
        run: pytest tests/test_e1_isolation.py::TestE1PipelineComplete -v -m slow
        continue-on-error: true  # Ne pas bloquer si test lent échoue
